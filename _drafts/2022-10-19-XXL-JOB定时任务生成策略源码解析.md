---
layout: post
title: XXL-JOB定时任务生成策略解析
subtitle:
categories: 定时任务
tags: [源码解析]
banner: "/assets/images/banners/home.jpeg"

---

图解


## **二. 数据模型**
**【jobinfo】**<br>

|属性|说明|
|---|---|
|triggerStatus|运行状态，0停止，1运行|
|triggerLastTime|上一次执行时间，long类型毫秒数|
|triggerNextTime|下一次执行时间，long类型毫秒数|

xxl-job的定时任务信息模型是包含运行时的执行信息的，并不是一个静态的定时任务的信息登记，
而是包括了这个定时任务运行时信息的追踪。


**【ringdata】**
map类型，保存一个时间轮。
- key为0-59，代表秒数
- value为List，代表这一秒钟要触发的定时任务列表


## **三. 线程模型**
xxljob是一个生产者消费者模型，
- 生产者scheduleThread负责生成定时任务，然后往时间轮上更新对应秒数的定时任务列表。
- 消费者ringThread负责消费时间轮上面的定时任务

**【scheduleThread】**
设计的初衷，生成5秒内的定时任务，放进ringThread中

循环进行单次扫描的逻辑：
1. 扫描成功，当前时间的5秒内有定时任务，则休眠1秒继续扫描下一个5秒的定时任务
2. 扫描失败，当前时间的5秒内没有定时任务，则休眠5秒后继续扫描下一个5秒的定时任务

单次扫描的逻辑：
1. 查询执行时间小于当前时间的5秒内的所有定时任务(有的博文说是查找当前时间5秒内的所有定时任务并不严谨，因为即使上一次执行时间不在这5秒内的定时任务也会被扫描到的）
2. 遍历这些定时任务，并根据这些定时任务与当前时间的关系做出不同的操作
   1. 当前时间比预定执行时间超过了5秒(一个检查周期)，属于没及时触发的过期定时任务，没有能及时触发，根据misfire策略执行
   2. 当前时间比预定时间大，但是在5秒内，即过了预定时间，但是还没有过这个5s的检查周期，立即触发
   3. 当前时间比预定时间小，即还没有到定时任务的触发时间，将当前任务放进时间轮钟，让ringThread进行触发。


**【ringThread】**
设计初衷，每一秒钟执行一次，将当前秒数在时间轮上的所有的定时任务拿出来执行。

循环进行单次执行的逻辑：
1. 




